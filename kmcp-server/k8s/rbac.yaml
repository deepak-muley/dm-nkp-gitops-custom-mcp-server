# RBAC for K8s-native MCP server
# Same permissions as the Go implementation
apiVersion: v1
kind: ServiceAccount
metadata:
  name: dm-nkp-gitops-mcp
  namespace: gitops-agent
  labels:
    app.kubernetes.io/name: dm-nkp-gitops-kmcp-server

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: dm-nkp-gitops-mcp
  labels:
    app.kubernetes.io/name: dm-nkp-gitops-kmcp-server
rules:
  # Core resources
  - apiGroups: [""]
    resources: [pods, pods/log, events, namespaces, configmaps, services]
    verbs: [get, list, watch]
  - apiGroups: [""]
    resources: [secrets]
    verbs: [get]
  - apiGroups: [apps]
    resources: [deployments, replicasets, statefulsets, daemonsets]
    verbs: [get, list, watch]

  # Flux CD
  - apiGroups: [kustomize.toolkit.fluxcd.io]
    resources: [kustomizations]
    verbs: [get, list, watch]
  - apiGroups: [source.toolkit.fluxcd.io]
    resources: [gitrepositories, helmrepositories, helmcharts, ocirepositories]
    verbs: [get, list, watch]
  - apiGroups: [helm.toolkit.fluxcd.io]
    resources: [helmreleases]
    verbs: [get, list, watch]

  # Cluster API
  - apiGroups: [cluster.x-k8s.io]
    resources: [clusters, machines, machinesets, machinedeployments]
    verbs: [get, list, watch]

  # Kommander
  - apiGroups: [apps.kommander.d2iq.io]
    resources: [apps, clusterapps]
    verbs: [get, list, watch]

  # Gatekeeper
  - apiGroups: [templates.gatekeeper.sh]
    resources: [constrainttemplates]
    verbs: [get, list, watch]
  - apiGroups: [constraints.gatekeeper.sh]
    resources: ["*"]
    verbs: [get, list, watch]

  # Kyverno
  - apiGroups: [kyverno.io]
    resources: [clusterpolicies, policies]
    verbs: [get, list, watch]
  - apiGroups: [wgpolicyk8s.io]
    resources: [clusterpolicyreports, policyreports]
    verbs: [get, list, watch]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: dm-nkp-gitops-mcp
  labels:
    app.kubernetes.io/name: dm-nkp-gitops-kmcp-server
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: dm-nkp-gitops-mcp
subjects:
  - kind: ServiceAccount
    name: dm-nkp-gitops-mcp
    namespace: gitops-agent
