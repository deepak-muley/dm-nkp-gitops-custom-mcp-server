# Kagent MCPServer CRD - K8s Native MCP Server Deployment
# This is the K8s-native way to deploy MCP servers using Kagent
apiVersion: kagent.dev/v1alpha1
kind: MCPServer
metadata:
  name: dm-nkp-gitops-mcp
  namespace: gitops-agent
  labels:
    app.kubernetes.io/name: dm-nkp-gitops-kmcp-server
    app.kubernetes.io/version: "0.1.0"
spec:
  # Container image
  image: ghcr.io/deepak-muley/dm-nkp-gitops-kmcp-server:0.1.0
  
  # Replicas for HA
  replicas: 1
  
  # Service account for K8s API access
  serviceAccountName: dm-nkp-gitops-mcp
  
  # Resource limits
  resources:
    limits:
      memory: "256Mi"
      cpu: "200m"
    requests:
      memory: "128Mi"
      cpu: "50m"
  
  # Environment variables
  env:
    - name: LOG_LEVEL
      value: "info"
    - name: POD_NAMESPACE
      valueFrom:
        fieldRef:
          fieldPath: metadata.namespace
  
  # Liveness/Readiness probes
  livenessProbe:
    httpGet:
      path: /health
      port: 8080
    initialDelaySeconds: 10
    periodSeconds: 30
  
  readinessProbe:
    httpGet:
      path: /health
      port: 8080
    initialDelaySeconds: 5
    periodSeconds: 10
  
  # Security context
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    readOnlyRootFilesystem: true
    capabilities:
      drop:
        - ALL

---
# If Kagent is not installed, use standard K8s resources as fallback
# Uncomment the resources below if you don't have Kagent operator

# apiVersion: apps/v1
# kind: Deployment
# metadata:
#   name: dm-nkp-gitops-kmcp-server
#   namespace: gitops-agent
# spec:
#   replicas: 1
#   selector:
#     matchLabels:
#       app: dm-nkp-gitops-kmcp-server
#   template:
#     metadata:
#       labels:
#         app: dm-nkp-gitops-kmcp-server
#     spec:
#       serviceAccountName: dm-nkp-gitops-mcp
#       containers:
#         - name: mcp-server
#           image: ghcr.io/deepak-muley/dm-nkp-gitops-kmcp-server:0.1.0
#           ports:
#             - containerPort: 8080
#           resources:
#             limits:
#               memory: "256Mi"
#               cpu: "200m"
